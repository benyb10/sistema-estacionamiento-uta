import '../styles/pages/Login.css';
import React, { useState, useEffect } from 'react';
import logoUTA from '../assets/images/UTA.png';
import { useNavigate } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';
import ModalVerificacion from '../components/common/ModalVerificacion';
// üöÄ Importar la configuraci√≥n centralizada
import { API_BASE_URL, API_ENDPOINTS, DEFAULT_HEADERS, logApiCall } from '../config/api';

function Login() {
  const [cedula, setCedula] = useState('');
  const [correo, setCorreo] = useState('');
  const [mensaje, setMensaje] = useState('');
  const [tipoMensaje, setTipoMensaje] = useState(''); // 'exito' o 'error'
  const [contrase√±a, setContrase√±a] = useState('');
  const [mostrarModalCodigo, setMostrarModalCodigo] = useState(false);
  const [codigoVerificacion, setCodigoVerificacion] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [validFields, setValidFields] = useState({});
  const [errors, setErrors] = useState({});
  
  const navigate = useNavigate();
  const { completeLogin } = useAuth(); // ‚úÖ Usar la nueva funci√≥n

  // Limpiar mensajes despu√©s de un tiempo
  useEffect(() => {
    if (mensaje) {
      const timer = setTimeout(() => {
        setMensaje('');
        setTipoMensaje('');
      }, 5000);
      return () => clearTimeout(timer);
    }
  }, [mensaje]);

  // Validaci√≥n en tiempo real
  const validarCampo = (campo, valor) => {
    const nuevosErrors = { ...errors };
    const nuevosValidos = { ...validFields };

    switch (campo) {
      case 'cedula':
        if (valor.length === 10 && /^\d+$/.test(valor)) {
          delete nuevosErrors.cedula;
          nuevosValidos.cedula = true;
        } else {
          nuevosErrors.cedula = 'C√©dula debe tener 10 d√≠gitos';
          delete nuevosValidos.cedula;
        }
        break;
      case 'correo':
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (emailRegex.test(valor)) {
          delete nuevosErrors.correo;
          nuevosValidos.correo = true;
        } else {
          nuevosErrors.correo = 'Formato de correo inv√°lido';
          delete nuevosValidos.correo;
        }
        break;
      case 'contrase√±a':
        if (valor.length >= 1) {
          delete nuevosErrors.contrase√±a;
          nuevosValidos.contrase√±a = true;
        } else {
          nuevosErrors.contrase√±a = 'Contrase√±a muy corta';
          delete nuevosValidos.contrase√±a;
        }
        break;
      default:
        break;
    }

    setErrors(nuevosErrors);
    setValidFields(nuevosValidos);
  };

  const manejarCambio = (campo, valor) => {
    switch (campo) {
      case 'cedula':
        // Solo permitir n√∫meros y m√°ximo 10 d√≠gitos
        if (/^\d*$/.test(valor) && valor.length <= 10) {
          setCedula(valor);
          validarCampo('cedula', valor);
        }
        break;
      case 'correo':
        setCorreo(valor);
        validarCampo('correo', valor);
        break;
      case 'contrase√±a':
        setContrase√±a(valor);
        validarCampo('contrase√±a', valor);
        break;
      default:
        break;
    }
  };

  const manejarLogin = async (e) => {
    e.preventDefault();
    setIsLoading(true);
    setMensaje('');

    // Validaci√≥n final
    if (Object.keys(errors).length > 0) {
      setMensaje('‚ùå Por favor corrige los errores en el formulario');
      setTipoMensaje('error');
      setIsLoading(false);
      return;
    }

    try {
      // üöÄ Usar la URL centralizada
      const url = `${API_BASE_URL}${API_ENDPOINTS.LOGIN}`;
      
      // üöÄ Log para desarrollo
      logApiCall('POST', url, { cedula, correo, contrase√±a: '***' });

      const response = await fetch(url, {
        method: 'POST',
        headers: DEFAULT_HEADERS,
        body: JSON.stringify({ cedula, correo, contrase√±a }),
      });

      if (response.ok) {
        setMostrarModalCodigo(true);
        setMensaje('‚úÖ Credenciales correctas. Se ha enviado un c√≥digo a su correo.');
        setTipoMensaje('exito');
      } else {
        const errorData = await response.json();
        setMensaje(`‚ùå ${errorData.error || 'Credenciales incorrectas. Verifique sus datos.'}`);
        setTipoMensaje('error');
      }
    } catch (error) {
      console.error('‚ùå Error al conectar con el servidor:', error);
      setMensaje('‚ùå Error de conexi√≥n. Verifique su conexi√≥n a internet.');
      setTipoMensaje('error');
    } finally {
      setIsLoading(false);
    }
  };

  // ‚úÖ Funci√≥n actualizada para verificar c√≥digo
  const verificarCodigo = async () => {
    if (!codigoVerificacion || codigoVerificacion.length !== 6) {
      setMensaje('‚ùå El c√≥digo debe tener 6 d√≠gitos');
      setTipoMensaje('error');
      return;
    }

    try {
      // üöÄ Usar la URL centralizada
      const url = `${API_BASE_URL}${API_ENDPOINTS.VERIFY_CODE}`;
      
      // üöÄ Log para desarrollo
      logApiCall('POST', url, { correo, codigo: codigoVerificacion });

      const response = await fetch(url, {
        method: 'POST',
        headers: DEFAULT_HEADERS,
        body: JSON.stringify({ correo, codigo: codigoVerificacion }),
      });

      const data = await response.json();

      if (response.ok) {
        setMensaje('‚úÖ ¬°Bienvenido! Redirigiendo al sistema...');
        setTipoMensaje('exito');
        setMostrarModalCodigo(false);
        
        // ‚úÖ Crear objeto usuario completo
        const userData = { 
          cedula, 
          correo,
          nombre: data.user?.nombre || `Usuario ${cedula}`,
          categoria: data.user?.categoria || 'ESTUDIANTE',
          fechaLogin: new Date().toISOString()
        };
        
        // ‚úÖ Usar la nueva funci√≥n completeLogin del AuthContext
        const loginResult = completeLogin(userData, data.token);

        if (loginResult.success) {
          console.log('‚úÖ Login completado exitosamente');
          
          // Redireccionar al dashboard
          setTimeout(() => {
            navigate('/dashboard');
          }, 1500);
        } else {
          setMensaje('‚ùå Error al inicializar sesi√≥n. Intente nuevamente.');
          setTipoMensaje('error');
        }
      } else {
        setMensaje(`‚ùå ${data.error || 'C√≥digo incorrecto o expirado. Intente nuevamente.'}`);
        setTipoMensaje('error');
      }
    } catch (error) {
      console.error('‚ùå Error en verificaci√≥n de c√≥digo:', error);
      setMensaje('‚ùå Error al verificar el c√≥digo. Intente nuevamente.');
      setTipoMensaje('error');
    }
  };

  const redirigirRegistro = () => {
    navigate('/');
  };

  const volverHome = () => {
    navigate('/');
  };

  const limpiarFormulario = () => {
    setCedula('');
    setCorreo('');
    setContrase√±a('');
    setMensaje('');
    setTipoMensaje('');
    setErrors({});
    setValidFields({});
  };

  return (
    <>
      <ModalVerificacion
        mostrar={mostrarModalCodigo}
        codigoVerificacion={codigoVerificacion}
        setCodigoVerificacion={setCodigoVerificacion}
        cerrar={() => {
          setMostrarModalCodigo(false);
          setCodigoVerificacion('');
        }}
        verificar={verificarCodigo}
        correo={correo}
      />
      
      <div className="login-fondo">
        <div className="login-container">
          <div className="login-box">
            <div className="login-logo">
              <img src={logoUTA} alt="Universidad T√©cnica de Ambato" />
              <h2>Sistema de Estacionamiento</h2>
              <p>Universidad T√©cnica de Ambato<br />Facultad de Ingenier√≠a en Sistemas</p>
              
              {/* üöÄ Mostrar URL de conexi√≥n en desarrollo */}
              {process.env.NODE_ENV === 'development' && (
                <small style={{ 
                  display: 'block', 
                  marginTop: '8px', 
                  color: '#666', 
                  fontSize: '0.8rem' 
                }}>
                  üîó Conectando a: {API_BASE_URL}
                </small>
              )}
            </div>

            <form className="login-form" onSubmit={manejarLogin}>
              <div className="input-group">
                <input
                  type="text"
                  placeholder="C√©dula de identidad"
                  value={cedula}
                  onChange={(e) => manejarCambio('cedula', e.target.value)}
                  className={errors.cedula ? 'invalid' : validFields.cedula ? 'valid' : ''}
                  required
                  maxLength="10"
                />
                {errors.cedula && <small className="error-text">{errors.cedula}</small>}
              </div>

              <div className="input-group">
                <input
                  type="email"
                  placeholder="Correo electr√≥nico institucional"
                  value={correo}
                  onChange={(e) => manejarCambio('correo', e.target.value)}
                  className={errors.correo ? 'invalid' : validFields.correo ? 'valid' : ''}
                  required
                />
                {errors.correo && <small className="error-text">{errors.correo}</small>}
              </div>

              <div className="input-group">
                <input
                  type="password"
                  placeholder="Contrase√±a"
                  value={contrase√±a}
                  onChange={(e) => manejarCambio('contrase√±a', e.target.value)}
                  className={errors.contrase√±a ? 'invalid' : validFields.contrase√±a ? 'valid' : ''}
                  required
                />
                {errors.contrase√±a && <small className="error-text">{errors.contrase√±a}</small>}
              </div>

              <button 
                type="submit" 
                className="login-button"
                disabled={isLoading || Object.keys(errors).length > 0}
              >
                {isLoading ? (
                  <>
                    <span className="loading-spinner-small"></span>
                    Verificando...
                  </>
                ) : (
                  'üîê Iniciar Sesi√≥n'
                )}
              </button>
            </form>

            {/* Mensajes de estado */}
            {mensaje && (
              <div className={`mensaje ${tipoMensaje}`}>
                <p>{mensaje}</p>
              </div>
            )}

            <div className="login-links">
              <button type="button" className="link-button" onClick={redirigirRegistro}>
                üìù ¬øNo tienes cuenta? Reg√≠strate
              </button>
              <button type="button" className="link-button" onClick={volverHome}>
                üè† Volver al inicio
              </button>
              <button type="button" className="link-button secondary" onClick={limpiarFormulario}>
                üßπ Limpiar formulario
              </button>
            </div>
          </div>
        </div>
      </div>
    </>
  );
}

export default Login;